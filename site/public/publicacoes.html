<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/publicacoes.css">
    <title>Publicações</title>
</head>

<body style="background-color: #97979b;">
    <!-- <body onload="validarSessao()"> -->

    <div class="janela">
        <div class="header-left">

            <div class="hello">
                <h1>PUBG</h1>
            </div>

            <div class="btn-nav-white">
                <a href="./menu.html">
                    <h3>Perfil</h3>
                </a>
            </div>

            <div class="btn-nav-white">
                <a href="dashboard.html">
                    <h3>Votação</h3>
                </a>
            </div>

            <div class="btn-nav">
                <a href="./publicacoes.html">
                    <h3>Publicações</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>
    </div>

    <div class="dash-right">
        <div class="partePublicar">
            <label for="inputTitulo" style="margin-left: 2%;">Titulo</label><br>
            <input id="inputTitulo" size="20" style="margin-left: 1%;"><br>
            <label for="inputDescricao" style="margin-left: 10%;">Mensagem</label><br>
	        <textarea id="inputDescricao" rows="2" cols="40" style="margin-left: 1%;"></textarea><br>
            <button onclick="publicar()" class="btPostar">Postar</button>
        </div><br><br><br>
        <div class="partePublicacoes" id="divPublicacao">
            <span></span>
        </div>
    </div>
    </div>


</html>

<script>
    window.onload = resgatarPublicacao()

    var idUsuario = sessionStorage.ID_USUARIO

    function publicar() {
        var tituloVar = document.getElementById('inputTitulo').value
        var descricaoVar = document.getElementById('inputDescricao').value

        console.log(tituloVar, descricaoVar)
        if (tituloVar == '' || descricaoVar == '') {
            alert('Não tem nada')
        }
        else {
            // Enviando o valor da nova input
            fetch("/pub/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    // crie um atributo que recebe o valor recuperado aqui
                    // Agora vá para o arquivo routes/usuario.js
                    tituloServer: tituloVar,
                    descricaoServer: descricaoVar,
                    idUsuarioServer: idUsuario
                })
            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    inputTitulo.value = ''
                    inputDescricao.value = ''

                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'publicação realizada com sucesso!',
                        showConfirmButton: false,
                        timer: 5000
                    })
                    setTimeout(() => {
                        window.location = "publicacoes.html";
                    }, "2000")

                } else {
                    throw ("Houve um erro ao tentar realizar o cadastro!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

            return false;
        }
    }

    function resgatarPublicacao() {
        fetch(`/pub/listarPublicacao`, { cache: "no-store" })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log("Dados recebidos: ", resposta);
                        exibirPublicacao(resposta)
                    });
                } else {
                    console.error("Nenhum dado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(
                    `Erro na obtenção dos dados p/ gráfico: ${error.message}`
                );
            });
    }

function exibirPublicacao(resposta) {
    for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];
        divPublicacao.innerHTML += `<div class="partePublicacoes" style="border: 2px solid black; background-color: rgb(98, 124, 98);">
                                        <span><b>Nome:</b>${registro.nomeUsuario}</span><br>
                                        <span><b>Titulo:</b>${registro.titulo}</span><br>
                                        <span><b>Descricao:</b>${registro.descricao}</span>
                                    </div>`;
    }
}

</script>